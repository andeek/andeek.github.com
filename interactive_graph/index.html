<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <title>Interactive Map</title>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script src="http://d3js.org/topojson.v1.min.js"></script>
</head>
<style>

svg.map {
    float: left;    
}

.background {
  fill: none;
  pointer-events: all;
}

#states {
  fill: #d4d4d4;
}

#states .active {
  fill: orange;
}

#state-borders {
  fill: none;
  stroke: #fff;
  stroke-width: 1.5px;
  stroke-linejoin: round;
  stroke-linecap: round;
  pointer-events: none;
}

circle {
    cursor:pointer    
}

.route {
  fill: none;
  stroke: red;
  stroke-width: 1.5px;
}
</style>

<body>
	<div id='container'></div>
</body>

<script>
var width = 960,
    height = 600,
	root = [],
	cities,
	cities_added = [],
	route;

var projection = d3.geo.albersUsa()
	.scale(1.07858243*width)
	.translate([width / 2, height / 2]);

var path = d3.geo.path()
	.projection(projection);
	
var svg = d3.select('#container').append("svg")
	.attr("tabindex", 1)
	.attr("width", width)
	.attr("height", height)
	.attr("class", "map");

g = svg.append("g");
	
d3.json("us_states_5m.json", function(error, us) {
	g.append("g")
	  .attr("id", "states")
	.selectAll("path")
	  .data(topojson.feature(us, us.objects.states).features)
	.enter().append("path")
	  .attr("d", path);
	
	g.append("path")
	  .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
	  .attr("id", "state-borders")
	  .attr("d", path);
	  
	//cities saved from R
	d3.csv("us.cities.csv", function(data) {
	   root = data.map(function(d) { return { name: d["name"], state: d["country.etc"], lat: +d["lat"], long: +d["long"], added: false }; });
	   update_map()
	});
	  
});


function update_map() {
	cities = g.selectAll('circle.city').data(root);  
	
	cities.enter()
		.append('circle')
		.attr("class", "city")
		.attr("transform", function(d) { 
			return "translate(" + projection([d.long, d.lat]) + ")"; 
		})
		.on("click", clicked)
		.append("title")
		.text(function(d){ return(d.name); });
		
	cities.transition().duration(750)
		.style('fill', function(e){ return(e.added ? "red" : "blue" ); })
		.attr('r', function(e){ return(e.added ? 5 : 3); })
		.style('stroke', '#7f7f7f')
		.style("stroke-width", .5);
            
	cities.exit().remove(); 
     
		
	route = {
	  type: "LineString",
	  coordinates: cities_added
	};

	g.append("path")
		.datum(route)
		.attr("class", "route")
		.attr("d", path);
}

function clicked(d) {    
    d.added = true;
	cities_added.push([d.long, d.lat]);
	update_map();
}
</script>

</html>

